<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="https://usetrmnl.com/css/latest/plugins.css">
    <script src="https://usetrmnl.com/js/latest/plugins.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;350;375;400;450;600;700&display=swap" rel="stylesheet">

    <style>
      /* Layout */
      .trmnl .view .layout {
        flex: 1;
      }
      
      .trmnl .view--quadrant .title_bar {
        background: none;
      }
      .trmnl .view--half_horizontal::before {
        background: none;
      }
  
      #root {
        font-family: 'Inter', 'NicoClean', sans-serif;
        width: 100%;
        height: 100%;
        display: flex;
        position: relative;
        overflow: hidden;
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
        z-index: 1;
      }
      #root:has(.pills-container--left) {
        flex-direction: row;
      }
      #root:has(.pills-container--right) {
        flex-direction: row-reverse;
      }
      #root:has(.pills-container--top) {
        flex-direction: column;
      }
      #root:has(.pills-container--bottom) {
        flex-direction: column-reverse;
      }
      .sections-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        width: 100%;
        max-width: 100%;
        min-width: 0;
      }

      /* Custom styles */
      .pills-container {
        margin-bottom: 10px;
      }
      
      .pills-container--top {
        margin-bottom: 10px;
      }
      
      .pills-container--bottom {
        margin-top: 10px;
      }
      
      .pills-container--left {
        margin-right: 10px;
      }
      
      .pills-container--right {
        margin-left: 10px;
      }

      .pill-component {
        border: 2px black solid;
        display: flex;
        align-items: center;
        gap: 5px;    
        padding: 3px 5px;
      }
      
      /* Rotate pills when on left or right side */
      .pills-container--left .pill-component,
      .pills-container--right .pill-component {
        writing-mode: vertical-lr;
        transform: rotate(180deg);
      }
      
      .app-root.list-layout .pill-component {
        border: none;
      }

      .entity-name, .entity-value {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .entity-value {
        max-width: 155px;
      }
      /* Entity group styling */
      .entity-group {
        border: 2px solid black;
        border-radius: 16px;
        padding: 16px;
        margin-top: 16px;
        background: #fff;
        position: relative;
      }
      
      .group-header {
        position: absolute;
        background: #fff;
        padding: 0 4px;
        z-index: 2;
      }

      .groups-layout .group-header {
        top: 0;
        transform: translateY(-50%);
        line-height: 1;
      }
      
      .group-header span {
        color: inherit;
      }

      .group-content {
        margin-top: 8px;
        gap: 20px;
      }

      .entity-card {
        min-width: 100px;
        margin: 0 auto;
      }

      .entity-header {
        display: flex;
        align-items: center;
        gap: 2px;
      }

      /* Groups layout */
      .groups-layout .free-layout-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .groups-layout .free-layout-container .group-content {
        display: flex;
        flex-wrap: wrap;
      }

      /* List layout styles */
      .list-layout .free-layout-container {
        max-width: 100%;
        column-gap: 60px;
        width: 46%;
        min-width: 250px;
        flex-wrap: wrap;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        row-gap: var(--list-gap-small);
      }
      
      .list-layout .free-layout-container .entity-group {
        width: 100%;
        background: none;
        border: none;
        border-radius: 0;
        margin: 0;
        padding: 0;
      }
      
      .list-layout .free-layout-container .group-header {
        font-weight: 600;
        margin-bottom: 8px;
        position: static;
        background: none;
        padding: 0;
      }
      
      .list-layout .free-layout-container .group-content {
        display: grid;
        width: 100%;
        break-inside: avoid;
        gap: 5px;
      }
      
      /* Dynamic grid columns based on what's shown */
      .list-layout .free-layout-container .group-content.show-all {
        grid-template-columns: 1fr 28px auto;
      }
      
      .list-layout .free-layout-container .group-content.hide-title {
        grid-template-columns: 28px auto;
      }
      
      .list-layout .free-layout-container .group-content.hide-icon {
        grid-template-columns: 1fr auto;
      }
      
      .list-layout .free-layout-container .group-content.hide-both {
        grid-template-columns: auto;
      }
      
      .list-layout .free-layout-container .entity-list-row {
        display: contents;
      }
      
      /* Common styles for list elements */
      .list-layout .free-layout-container .entity-list-row .entity-name {
        font-weight: 400;
        white-space: nowrap;
        text-align: left;
        align-self: center;
      }
      
      .list-layout .free-layout-container .entity-list-row .entity-icon {
        justify-self: center;
        align-self: center;
        display: flex;
        align-items: center;
      }
      
      .list-layout .free-layout-container .entity-list-row .entity-value {
        font-weight: 500;
        white-space: nowrap;
        text-align: right;
        align-self: center;
      }
      
      /* Grid column assignments based on visibility */
      .list-layout .free-layout-container .group-content.show-all .entity-name { grid-column: 1; }
      .list-layout .free-layout-container .group-content.show-all .entity-icon { grid-column: 2; }
      .list-layout .free-layout-container .group-content.show-all .entity-value { grid-column: 3; }
      
      .list-layout .free-layout-container .group-content.hide-title .entity-icon { grid-column: 1; }
      .list-layout .free-layout-container .group-content.hide-title .entity-value { grid-column: 2; }
      
      .list-layout .free-layout-container .group-content.hide-icon .entity-name { grid-column: 1; }
      .list-layout .free-layout-container .group-content.hide-icon .entity-value { grid-column: 2; }
      
      .list-layout .free-layout-container .group-content.hide-both .entity-value { grid-column: 1; }

      .mashup--1Lx1R .free-layout-container, .mashup--2x2 .free-layout-container {
        width: 100%;
      }

      /* Weather visualization styles - black and white, icon only */
      .visualizations-container {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .weather-visualization {
        width: 100%;
        min-width: 250px;
        max-width: 380px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        background: #fff;
        border: 2px solid #000;
        border-radius: 16px;
        padding: 16px;
        color: #000;
      }
      .weather-main-row {
        display: flex;
        align-items: center;
        gap: 18px;
        margin-bottom: 8px;
      }
      .weather-icon {
        width: 56px;
        height: 56px;
        flex-shrink: 0;
        filter: grayscale(1) contrast(1.2);
      }
      .weather-main-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
        align-items: flex-start;
      }
      .weather-temp {
        font-weight: 700;
        letter-spacing: -1px;
        line-height: 1.1;
        font-size: 2.2em;
        color: #000;
      }
      .weather-details-row {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        margin-top: 10px;
      }
      .weather-detail {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 2px 6px;
        border-left: 1px solid #000;
        color: #000;
        background: none;
      }
      .weather-detail-icon {
        width: 22px;
        height: 22px;
        filter: grayscale(1) contrast(1.2);
      }
      .weather-detail-value {
        font-weight: 500;
        font-size: 1.1em;
        color: #000;
      }

    
    </style>
  </head>
  <body class="environment trmnl">
      <div class="view view--full view--half_vertical view--half_horizontal view--quadrant">
        <div class="layout">
          <script>
     

class HomeAssistantRenderer {
  constructor(containerId = 'root', configuration = {}) {
    this.container = document.getElementById(containerId);
    this.iconMap = this.createIconMap();
    // Use configuration from webhook
    this.layoutClass = (configuration.layout || 'groups') + '-layout';
    this.pillPosition = configuration.pill_position || 'top';
    this.showEntityTitle = configuration.show_entity_title !== undefined ? (configuration.show_entity_title === true || configuration.show_entity_title === 'true') : true;
    this.showEntityIcon = configuration.show_entity_icon !== undefined ? (configuration.show_entity_icon === true || configuration.show_entity_icon === 'true') : true;
    this.scale = configuration.scale || 'normal';
    this.initScaleClasses();
    this.init();
  }

    createWeatherVisualization(entity) {
      // Weather icon mapping for states
      const weatherIcons = {
        'clear-night': 'mdi:weather-night',
        'cloudy': 'mdi:weather-cloudy',
        'fog': 'mdi:weather-fog',
        'hail': 'mdi:weather-hail',
        'lightning': 'mdi:weather-lightning',
        'lightning-rainy': 'mdi:weather-lightning-rainy',
        'partlycloudy': 'mdi:weather-partly-cloudy',
        'pouring': 'mdi:weather-pouring',
        'rainy': 'mdi:weather-rainy',
        'snowy': 'mdi:weather-snowy',
        'snowy-rainy': 'mdi:weather-snowy-rainy',
        'sunny': 'mdi:weather-sunny',
        'windy': 'mdi:weather-windy',
        'windy-variant': 'mdi:weather-windy-variant',
        'exceptional': 'mdi:alert',
      };
      // Detail icons (black and white, meaningful)
      const detailIcons = {
        humidity: 'mdi:water-percent',
        pressure: 'mdi:gauge',
        wind: 'mdi:weather-windy',
        clouds: 'mdi:weather-cloudy',
        visibility: 'mdi:eye',
      };
      const stateIcon = weatherIcons[entity.state] || 'mdi:weather-partly-cloudy';
      const iconUrl = `https://api.iconify.design/${stateIcon}.svg`;
      const temp = entity.attributes?.temperature;
      const tempUnit = entity.attributes?.temperature_unit || '°C';
      const humidity = entity.attributes?.humidity;
      const pressure = entity.attributes?.pressure;
      const pressureUnit = entity.attributes?.pressure_unit || 'hPa';
      const windSpeed = entity.attributes?.wind_speed;
      const windSpeedUnit = entity.attributes?.wind_speed_unit || 'km/h';
      const windBearing = entity.attributes?.wind_bearing;
      const cloudCoverage = entity.attributes?.cloud_coverage;
      const visibility = entity.attributes?.visibility;
      const visibilityUnit = entity.attributes?.visibility_unit || 'km';
      return `
        <div class="weather-visualization">
          <div class="weather-main-row">
            <img class="weather-icon" src="${iconUrl}" alt="${entity.state}">
            <div class="weather-main-info">
              <div class="weather-temp value ${this.textClasses.entityValue} ${typeof temp === 'number' ? 'value--tnums' : ''}">${temp !== undefined ? temp + ' ' + tempUnit : ''}</div>
            </div>
          </div>
          <div class="weather-details-row">
            ${humidity !== undefined ? `<div class="weather-detail"><img class="weather-detail-icon" src="https://api.iconify.design/${detailIcons.humidity}.svg" alt="Humidity"><span class="weather-detail-value">${humidity}%</span></div>` : ''}
            ${pressure !== undefined ? `<div class="weather-detail"><img class="weather-detail-icon" src="https://api.iconify.design/${detailIcons.pressure}.svg" alt="Pressure"><span class="weather-detail-value">${pressure} ${pressureUnit}</span></div>` : ''}
            ${windSpeed !== undefined ? `<div class="weather-detail"><img class="weather-detail-icon" src="https://api.iconify.design/${detailIcons.wind}.svg" alt="Wind"><span class="weather-detail-value">${windSpeed} ${windSpeedUnit}${windBearing !== undefined ? ' (' + windBearing + '°)' : ''}</span></div>` : ''}
            ${cloudCoverage !== undefined ? `<div class="weather-detail"><img class="weather-detail-icon" src="https://api.iconify.design/${detailIcons.clouds}.svg" alt="Clouds"><span class="weather-detail-value">${cloudCoverage}%</span></div>` : ''}
            ${visibility !== undefined ? `<div class="weather-detail"><img class="weather-detail-icon" src="https://api.iconify.design/${detailIcons.visibility}.svg" alt="Visibility"><span class="weather-detail-value">${visibility} ${visibilityUnit}</span></div>` : ''}
          </div>
        </div>
      `;
    }

  initScaleClasses() {
    // Define text size classes based on scale setting
    const scaleConfig = {
      small: {
        pillValue: 'value--xxsmall',
        entityValue: 'value--xsmall',
        entityUnit: 'value--xxsmall',
        deviceClass: 'value--xxsmall',
        groupHeader: 'value--xsmall',
        entityName: 'value--xxsmall',
        iconSize: '20px'
      },
      normal: {
        pillValue: 'value--xsmall',
        entityValue: 'value--small',
        entityUnit: 'value--xsmall',
        deviceClass: 'value--xsmall',
        groupHeader: 'value--small',
        entityName: 'value--xsmall',
        iconSize: '25px'
      },
      big: {
        pillValue: 'value--small',
        entityValue: 'value--regular',
        entityUnit: 'value--small',
        deviceClass: 'value--small',
        groupHeader: 'value--medium',
        entityName: 'value--small',
        iconSize: '30px'
      }
    };
    
    this.textClasses = scaleConfig[this.scale] || scaleConfig.normal;
  }

  init() {
    if (!this.container) {
      return;
    }
    this.container.className = `app-root ${this.layoutClass}`;
  }

  createIconMap() {
    return {
      // Domain-based icons
      'light': 'mdi:lightbulb',
      'switch': 'mdi:toggle-switch',
      'sensor': 'mdi:chart-line',
      'climate': 'mdi:thermostat',
      'cover': 'mdi:window-shutter',
      'fan': 'mdi:fan',
      'lock': 'mdi:lock',
      'media_player': 'mdi:speaker',
      'camera': 'mdi:camera',
      'alarm_control_panel': 'mdi:security',
      'automation': 'mdi:cog',
      'script': 'mdi:script-text',
      'scene': 'mdi:palette',
      'input_boolean': 'mdi:checkbox-marked',
      'input_number': 'mdi:numeric',
      'input_select': 'mdi:format-list-bulleted',
      'input_text': 'mdi:form-textbox',
      'timer': 'mdi:timer',
      'counter': 'mdi:counter',
      'person': 'mdi:account',
      'device_tracker': 'mdi:map-marker',
      'zone': 'mdi:map',
      'sun': 'mdi:weather-sunny',
      'weather': 'mdi:weather-partly-cloudy',
      'conversation': 'mdi:message-text',
      'notify': 'mdi:bell',
      'tts': 'mdi:volume-high',
      'group': 'mdi:account-group',
      'homeassistant': 'mdi:home-assistant',
      
      // Device class specific icons
      'temperature': 'mdi:thermometer',
      'humidity': 'mdi:water-percent',
      'pressure': 'mdi:gauge',
      'battery': 'mdi:battery',
      'illuminance': 'mdi:brightness-6',
      'motion': 'mdi:motion-sensor',
      'door': 'mdi:door',
      'window': 'mdi:window-closed',
      'smoke': 'mdi:smoke-detector',
      'gas': 'mdi:gas-cylinder',
      'power': 'mdi:flash',
      'energy': 'mdi:lightning-bolt',
      'current': 'mdi:current-ac',
      'voltage': 'mdi:sine-wave',
      'frequency': 'mdi:waveform',
      'signal_strength': 'mdi:signal',
      'connectivity': 'mdi:wifi',
      'co2': 'mdi:molecule-co2',
      'pm25': 'mdi:air-filter',
      
      // Fallback icons
      'default': 'mdi:information',
      'error': 'mdi:alert-circle',
      'unknown': 'mdi:help-circle'
    };
  }

  getEntityIcon(entity) {
    if (!entity.attributes) {
      return
    }
    if (entity.attributes.icon) {
      return entity.attributes.icon;
    }
    if (entity.error) {
      return this.iconMap.error;
    }

    const entityId = entity.entity_id || '';
    const domain = entityId.split('.')[0];
    const deviceClass = entity.attributes?.device_class;
    
    if (deviceClass && this.iconMap[deviceClass]) {
      return this.iconMap[deviceClass];
    }
    
    if (domain && this.iconMap[domain]) {
      return this.iconMap[domain];
    }
    
    return this.iconMap.default;
  }

  getEntityName(entity) {
    if (entity.error) {
      return 'Error';
    }
    
    return entity.attributes?.friendly_name || entity.entity_id || 'Unknown Entity';
  }

  getDeviceClassTitle(entity) {
    if (entity.error) {
      return null;
    }
    
    const deviceClass = entity.attributes?.device_class ?? '';
    
    // Capitalize first letter and replace underscores with spaces
    return entity.attributes?.friendly_name ?? (deviceClass.charAt(0).toUpperCase() + deviceClass.slice(1).replace(/_/g, ' '));
  }

  formatEntityState(entity) {
    if (entity.error) {
      return {
        value: entity.error,
        unit: '',
        isError: true,
        isNumeric: false
      };
    }

    const state = entity.state;
    const unit = entity.attributes?.unit_of_measurement || '';
    
    // Handle special states
    if (state === 'on' || state === 'off') {
      return {
        value: state.toUpperCase(),
        unit: '',
        isError: false,
        isNumeric: false
      };
    }
    
    // Handle numeric values
    if (!isNaN(state) && state !== '') {
      const numValue = parseFloat(state);
      return {
        value: numValue % 1 === 0 ? numValue.toString() : numValue.toFixed(1),
        unit: unit,
        isError: false,
        isNumeric: true
      };
    }
    
    // Handle datetime values
    if (state && state.includes('T') && state.includes(':')) {
      try {
        const date = new Date(state);
        return {
          value: date.toLocaleString(),
          unit: '',
          isError: false,
          isNumeric: false
        };
      } catch (e) {
        // If date parsing fails, return as is
      }
    }
    
    return {
      value: state || 'N/A',
      unit: unit,
      isError: false,
      isNumeric: false
    };
  }

  /**
   * Get CSS class for entity icon based on domain
   */
  getEntityIconClass(entity) {
    if (entity.error) {
      return 'entity-icon error';
    }
    
    const entityId = entity.entity_id || '';
    const domain = entityId.split('.')[0];
    const deviceClass = entity.attributes?.device_class;
    
    const iconClass = deviceClass || domain || 'default';
    return `entity-icon ${iconClass}`;
  }

  formatIconForUrl(iconName) {
    if (!iconName) {
      return 'mdi:help-circle';
    }
    
    if (iconName.includes(':')) {
      return iconName;
    }
    
    if (iconName.startsWith('mdi-')) {
      return iconName.replace('mdi-', 'mdi:');
    }
    
    return `mdi:${iconName}`;
  }

  createPill(entity) {
    const name = this.getEntityName(entity);
    const icon = entity.icon ?? this.getEntityIcon(entity);
    const stateInfo = this.formatEntityState(entity);
    
    const formattedIcon = this.formatIconForUrl(icon);
    const iconUrl = `https://api.iconify.design/${formattedIcon}.svg`;
        
    return `
      <div class="pill-component rounded--full" data-entity-id="${entity.entity_id || 'error'}">
        <img class="image" src="${iconUrl}" alt="${name}" style="width: ${this.textClasses.iconSize}; height: ${this.textClasses.iconSize};" onerror="this.style.display='none'">
        <span class="pill-value ${this.textClasses.pillValue} ${stateInfo.isNumeric ? 'value--tnums' : ''}">${stateInfo.value}${stateInfo.unit ? ' ' + stateInfo.unit : ''}</span>
      </div>
    `;
  }

  createEntityCard(entity, label) {
    const name = this.getEntityName(entity);
    const icon = entity.icon ?? this.getEntityIcon(entity);
    const iconClass = this.getEntityIconClass(entity);
    const stateInfo = this.formatEntityState(entity);
    const deviceClassTitle = this.showEntityTitle ? this.getDeviceClassTitle(entity) : '';
    
    const baseCardClass = entity.error ? 'entity-card error' : 'entity-card';
    
    const formattedIcon = this.formatIconForUrl(icon);
    const iconUrl = `https://api.iconify.design/${formattedIcon}.svg`;

    // Simple style (original)
    return `
      <div class="${baseCardClass}" data-entity-id="${entity.entity_id || 'error'}" data-label="${label}">
        ${deviceClassTitle ? `<div class="device-class-title value ${this.textClasses.deviceClass}">${deviceClassTitle}</div>` : ''}
        <div class="entity-header">
          ${this.showEntityIcon ? `<img class="image ${iconClass}" src="${iconUrl}" alt="${name}" style="width: ${this.textClasses.iconSize};" onerror="this.style.display='none'">` : ''}
          <div class="entity-value value ${this.textClasses.entityValue} ${stateInfo.isNumeric ? 'value--tnums' : ''} ${stateInfo.isError ? 'entity-error' : ''}">
            ${stateInfo.value}
            ${stateInfo.unit ? `<span class="entity-unit value ${this.textClasses.entityUnit}">${stateInfo.unit}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }

  createPillsContainer(pills) {
    if (!pills || pills.length === 0) {
      return '';
    }
    
    const allPills = pills.map(pill => this.createPill(pill));
    
    if (allPills.length === 0) {
      return '';
    }
    
      // Use flex classes for pills layout based on position
      let flexClass = '';
      switch (this.pillPosition) {
        case 'top':
          flexClass = 'flex flex--row flex--center-x flex--top';
          break;
        case 'bottom':
          flexClass = 'flex flex--row flex--center-x flex--bottom';
          break;
        case 'left':
          flexClass = 'flex flex--col flex--left flex--center-y';
          break;
        case 'right':
          flexClass = 'flex flex--col flex--right flex--center-y';
          break;
        default:
          flexClass = 'flex flex--row flex--center-x flex--top';
      }
      return `
        <div class="pills-container pills-container--${this.pillPosition} ${flexClass} gap">
          ${allPills.join('')}
        </div>
      `;
  }

  createEntitySection({ entities, groupName }) {
      if (this.layoutClass === 'list-layout') {
        // List layout: 2 columns, each 400px, left then right
        const entityRows = entities.map(entity => {
          const name = this.getEntityName(entity);
          const icon = entity.icon ?? this.getEntityIcon(entity);
          const iconClass = this.getEntityIconClass(entity);
          const stateInfo = this.formatEntityState(entity);
          const formattedIcon = this.formatIconForUrl(icon);
          const iconUrl = `https://api.iconify.design/${formattedIcon}.svg`;
            return `
              <div class="entity-list-row" data-entity-id="${entity.entity_id || 'error'}">
                ${this.showEntityTitle ? `<span class="entity-name value ${this.textClasses.entityName}">${name}</span>` : ''}
                ${this.showEntityIcon ? `<img class="entity-icon ${iconClass}" src="${iconUrl}" alt="${name}" style="width: ${this.textClasses.iconSize}; height: ${this.textClasses.iconSize};" onerror="this.style.display='none'">` : ''}
                <span class="entity-value value ${this.textClasses.entityValue} ${stateInfo.isNumeric ? 'value--tnums' : ''}">${stateInfo.value}${stateInfo.unit ? ' ' + stateInfo.unit : ''}</span>
              </div>
            `;
        });
        
        // Determine which CSS class to use based on visibility settings
        let gridClass = 'show-all';
        if (!this.showEntityTitle && !this.showEntityIcon) {
          gridClass = 'hide-both';
        } else if (!this.showEntityTitle) {
          gridClass = 'hide-title';
        } else if (!this.showEntityIcon) {
          gridClass = 'hide-icon';
        }
        
        return `
          <div class="entity-group" data-label="${groupName}">
            <div class="group-header">
              ${groupName ? `<span class="value ${this.textClasses.groupHeader}">${groupName}</span>` : ''}
            </div>
            <div class="group-content ${gridClass}">
              ${entityRows.join('')}
            </div>
          </div>
        `;
      } else {
        // Default (card) layout
        const entitiesHtml = entities
          .map(entity => this.createEntityCard(entity, groupName))
          .join('');
        return `
          <div class="entity-group" data-label="${groupName}">
            <div class="group-header">
              ${groupName ? `<span class="value ${this.textClasses.groupHeader}">${groupName}</span>` : ''}
            </div>
            <div class="group-content grid grid--wrap grid--min-56 entities-grid">
                ${entitiesHtml}
            </div>
          </div>
        `;
      }
  }

  render(webhookData) {
    if (!this.container) {
      return;
    }

    this.container.innerHTML = '';

    const { groups, pills, visualizations } = webhookData || {};    
    
    if (!visualizations?.length && !groups?.length && !pills?.length ) {
      this.renderEmptyState();
      return;
    }

    // Create pills container
    const pillsHtml = this.createPillsContainer(pills);

      // Create entity sections
      let mainContentHtml = '';
      
      if (visualizations?.length > 0) {
        const vizSections = visualizations.map(viz => {
          const domain = viz.entity_id.split('.')[0];
          if (domain === 'weather') {
            return this.createWeatherVisualization(viz);
          } else {
            return `<div class="visualization-container" data-viz-id="${viz.entity_id}"></div>`;
          }
        });

          mainContentHtml += `<div class="visualizations-container">${vizSections.join('')}</div>`;
      }

      if (groups.length > 0) {
        const sections = groups.map(group => {
          return this.createEntitySection(group);
        });
        mainContentHtml += `<div class="free-layout-container">${sections.join('')}</div>`;
      }

      // Create the layout structure
      if (pillsHtml) {
        this.container.innerHTML = `
          ${pillsHtml}
          <div class="main-content">
            ${mainContentHtml}
          </div>
        `;
      } else {
        this.container.innerHTML = `
          <div class="main-content">
            ${mainContentHtml}
          </div>
        `;
      }
  }

  renderEmptyState() {
    this.container.innerHTML = `
      <div class="main-content">
        <div class="empty-state">
          <div class="empty-state-icon value value--xxxlarge">⚠</div>
          <h3 class="value value--large">No entities found</h3>
          <p class="value value--small">Check your Home Assistant configuration and ensure entities are properly configured.</p>
        </div>
      </div>
    `;
  }

  updateEntity(entityId, newData) {
    const card = this.container.querySelector(`[data-entity-id="${entityId}"]`);
    if (card) {
      const label = card.getAttribute('data-label');
      card.outerHTML = this.createEntityCard(newData, label);
    }
  }

  refresh(responsesByLabel, pillsByLabel) {
    this.render(responsesByLabel, pillsByLabel);
  }
}

function initializeHomeAssistantRenderer() {
  try {
    // Get webhook data
    const webhookData = {
      groups: {{ groups | json }},
      pills: {{ pills | json }},
      visualizations: {{ visualizations | json }},
      configuration: {{ configuration | json }}
    };

    if (!webhookData) {
      throw new Error('No webhook data received. Please ensure the HACS TRMNL Dashboard integration is properly configured and sending data.');
    }

    const rootElement = document.getElementById('root');
    if (!rootElement) {
      return;
    }

    // Pass configuration from webhookData
    const renderer = new HomeAssistantRenderer('root', webhookData.configuration || {});
    renderer.render(webhookData);
  } catch (error) {
    console.error('Error initializing renderer:', error);
    const rootElement = document.getElementById('root');
    if (rootElement) {
      rootElement.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #f44336;">
          <h3 class="value value--large">❌ Error Loading Home Assistant Data</h3>
          <p class="value value--small">Please check the browser console for details.</p>
          <pre class="value value--small" style="background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; text-align: left; overflow: auto;">${error.message}</pre>
        </div>
      `;
    }
  }
}
          </script>

          <div id="root">
            <!-- Entities will be rendered here -->
          </div>

          <script>
            document.addEventListener('DOMContentLoaded', function () {
              try {
                initializeHomeAssistantRenderer();

                if (window.trmnl) {
                  window.trmnl.ready();
                } else {
                  document.dispatchEvent(new CustomEvent('trmnl-ready'));

                  window.trmnlReady = true;
                }
              } catch (error) {
                if (window.trmnl) {
                  window.trmnl.ready();
                } else {
                  document.dispatchEvent(new CustomEvent('trmnl-ready'));
                  window.trmnlReady = true;
                }
              }
            });

            if (document.readyState === 'complete' || document.readyState === 'interactive') {
              setTimeout(() => {
                try {
                  initializeHomeAssistantRenderer();

                  if (window.trmnl) {
                    window.trmnl.ready();
                  } else {
                    document.dispatchEvent(new CustomEvent('trmnl-ready'));
                    window.trmnlReady = true;
                  }
                } catch (error) {
                  if (window.trmnl) {
                    window.trmnl.ready();
                  } else {
                    document.dispatchEvent(new CustomEvent('trmnl-ready'));
                    window.trmnlReady = true;
                  }
                }
              }, 100);
            }
          </script>
        </div>

        {% if trmnl.plugin_settings.custom_fields_values.show_title_bar != 'false' %}
          <div class="title_bar">
            <svg class="image" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 240 240" fill="none">
<path d="M240 224.762C240 233.012 233.25 239.762 225 239.762H15C6.75 239.762 0 233.012 0 224.762V134.762C0 126.512 4.77 114.993 10.61 109.153L109.39 10.3725C115.22 4.5425 124.77 4.5425 130.6 10.3725L229.39 109.162C235.22 114.992 240 126.522 240 134.772V224.772V224.762Z" fill="#F2F4F9"/>
<path d="M229.39 109.153L130.61 10.3725C124.78 4.5425 115.23 4.5425 109.4 10.3725L10.61 109.153C4.78 114.983 0 126.512 0 134.762V224.762C0 233.012 6.75 239.762 15 239.762H107.27L66.64 199.132C64.55 199.852 62.32 200.262 60 200.262C48.7 200.262 39.5 191.062 39.5 179.762C39.5 168.462 48.7 159.262 60 159.262C71.3 159.262 80.5 168.462 80.5 179.762C80.5 182.092 80.09 184.322 79.37 186.412L111 218.042V102.162C104.2 98.8225 99.5 91.8425 99.5 83.7725C99.5 72.4725 108.7 63.2725 120 63.2725C131.3 63.2725 140.5 72.4725 140.5 83.7725C140.5 91.8425 135.8 98.8225 129 102.162V183.432L160.46 151.972C159.84 150.012 159.5 147.932 159.5 145.772C159.5 134.472 168.7 125.272 180 125.272C191.3 125.272 200.5 134.472 200.5 145.772C200.5 157.072 191.3 166.272 180 166.272C177.5 166.272 175.12 165.802 172.91 164.982L129 208.892V239.772H225C233.25 239.772 240 233.022 240 224.772V134.772C240 126.522 235.23 115.002 229.39 109.162V109.153Z" fill="#000"/>
</svg>
            <span class="title">Home Assistant Dashboard</span>
          </div>
        {% endif %}
      </div>
  </body>
</html>
